# 模拟交易启发2：规避阀值变化率
#reduce_trade_frequency
[code](https://github.com/EmbraceLife/LIE/blob/master/my_utils/viz_03_stock_03_ETF_simple_cut_frequency.py)

## 阀值变化率的漏洞
- 使用阀值的目的：刷选出更明确的买入或卖出信号，降低交易频率
- 什么是阀值率：相邻两天预测值变化比率
  - 公式： `rate = |y_pred[idx] - y_pred[idx-1]| / y_pred[idx-1]`
  - 预期状态：当预测值在从0.1到0.9之间变化时，这些预测值都忽略不考虑，持仓股数维持不变
- 为什么用rate，而不用买入阀值和卖出阀值组合？
  - 不需要定义买入和卖出两个不同的变量，一个变化率的变量更简洁
- 如何使用阀值变化率：
  - `if rate < 0.9: 持仓与前一天保持一致；else：预测值决定持仓市值`
  - 状况1（该公式OK）：y_pred1=1.0,  y_pred2 = 0.1；
  - 状况2（失败）：y_pred1=0.4,  y_pred2 = 0.8；
    - rate > 0.9, 预测值在0.1-0.9之间还是产生交易了
  - 修改后的公式，对状况2更合理：`rate = |y_pred[idx] - y_pred[idx-1]| / max(y_pred[idx-1], y_pred[idx])`
  - 状况3（失败): y_pred1=0.01,  y_pred2 = 0.1；
    - 本应该对应y_pred2的这天无交易产生，即rate应该小于0.9
    - 但上述公式得到的rate=0.9, 也很容易大于0.9，所以会产生交易制造成本
- 阀值比率允许大量微量变化的存在，实际交易计算非常不现实
  - 比如，当rate < 0.9时，用于交易计算的预测值可以是
    - y_pred = [0.99， 0.08， 0.94， 0.02， 0.997…]
- sigmoid的预测值处理定位于生成全买入和全卖出信号
  - sigmoid特点：生成[0,1]之间的概率
  - 适用于二元选择，这里就是买入或卖出，两个选择
  - 因此，除了1 和0 以外的数值都没有意义
## 新的阀值公式
- 设置预测值的买入阀值（比如>0.9）和预测值卖出阀值（比如<0.1)
- 当预测值大于0.9时，将值设为1.0；当预测值小于0.1时，将值设为0.0
- 所有中间的预测值，全部转化为0.5
- 当预测值等于0.5时，将该预测值的用前一天的预测值代替
- 当预测值为1时，全仓买入；当预测值为0时，全部平仓


## 新阀值的算法大幅提升了收益率（约40个百分点）和降低了交易频率（约降80次换手率）

**ETF50，买入阀值设为0.85, 0.9, 0.95; 卖出阀值设为0.15, 0.10, 0.05**

![](https://d2mxuefqeaa7sj.cloudfront.net/s_28217CE13FCEA11A60888FF8960A344C0424645956FE2C61D1D81254468CE643_1501241489244_ETF50_85_15.png)

![](https://d2mxuefqeaa7sj.cloudfront.net/s_28217CE13FCEA11A60888FF8960A344C0424645956FE2C61D1D81254468CE643_1501241489254_ETF50_90_10.png)

![](https://d2mxuefqeaa7sj.cloudfront.net/s_28217CE13FCEA11A60888FF8960A344C0424645956FE2C61D1D81254468CE643_1501241489259_ETF50_95_05.png)


**ETF300， 买入阀值0.9，0.95，0.99， 卖出阀值：0.1，0.05，0.01**

![](https://d2mxuefqeaa7sj.cloudfront.net/s_28217CE13FCEA11A60888FF8960A344C0424645956FE2C61D1D81254468CE643_1501242008809_ETF300_90_10.png)

![](https://d2mxuefqeaa7sj.cloudfront.net/s_28217CE13FCEA11A60888FF8960A344C042464596FE2C61D1D81254468CE643_1501242008815_ETF300_95_05.png)

![](https://d2mxuefqeaa7sj.cloudfront.net/s_28217CE13FCEA11A60888FF8960A344C0424645956FE2C61D1D81254468CE643_1501242008821_ETF300_99_01.png)
