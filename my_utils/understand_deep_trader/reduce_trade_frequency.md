# 如何降低交易频率-尝试3

## 不变的
- 沿用模型：输出一个预测值，只做一次sigmoid处理
```
 _________________________________________________________________
Layer (type)                 Output Shape              Param #
 =================================================================
dropout_1 (Dropout)          (None, 30, 61)            0
 _________________________________________________________________
lstm_1 (LSTM)                (None, 16)                4992
 _________________________________________________________________
dense_1 (Dense)              (None, 1)                 17
 _________________________________________________________________
activation_2 (sigmoid)       (None, 1)                 0
 =================================================================
Total params: 5,009
Trainable params: 5,009
Non-trainable params: 0
 _________________________________________________________________
Train on 84332 samples, validate on 17500 samples
```
- 损失函数不变：
```python
def risk_estimation(y_true, y_pred):
    return -100. * K.mean((y_true - 0.0002) * y_pred)
```
- 特征值：（?, 30, 61）
- 目标值： (?, 1)

## 模型训练状况
- 只训练了300 epoch (次)，最好能训练1000次
- 从损失值上判断效果和之前的模型（训练1000次，验证损失最佳值在-0.15左右）没什么太大差距， 见下图
![](https://lh3.googleusercontent.com/CQw-U9vireeGK4-7ljRVw8mv8tIdhiMQCP-Lts4J2siMCCMRXowy4125Zpse5egQi1HaJvj3xOKVndvN1rMLb2zkZ-d9bd6yuGgaCcPDfYzW9hxt6HPEBotAskeONHlGidK151KxhumI5OOU4YJdWaaDiDjquu-bZ5M8LHCMrt19aDD1Hf1k2Fc283xnrGB1TqlITYkIJO4YnArV1eqW0evD2BmYy-hbtAlGymtDHfIeBLGExs4fnx7o1v0V9_v2LjO9V_4Vi8bkmzzv-CtqP9ReL-FhmtfzKIG3icaXBKbbL2gVGDy-r2mmrwQTvtx5ylAytgd7JxIIdB66bf-m7K4yIqIgPvQ7TAGTOEErAEtawCiiD5XkOPb_qlrQa3W7nbOGjxqal3PKOTMiSHGX0PWN83gjt5cO0wXO7QdDRpnk5i_9Tbbvf3upKCatz0On0ROboJTuZj8pa1dVY6sxL3RcMjiDDMu-Conehob52nePQi80mGSCD1MTKe-x3iKyvXlMGDHM5GPxtGAJJrir60lhsMwcYAPxFZ8DzcRdlbJjqqa_8g15OFf-2gLVmvTrFsXGLPCQlYt_a-oqRb7Cfx6LZRzgYtf2NveX1PKGGFeh5HuZmhlyvXBn=w686-h1136-no)
- 模型预测值在被处理前的分布，见下图,(下分图为处理前的分布，上分图为处理后的分布)
![](https://lh3.googleusercontent.com/yjmnE6AlxIsuQrf6AYepbjXIZ0B5v54lhsm1yHAvlVnACRBWoeYJv3GxfeVq61gy66bBLl9affVqBVLU-rAZpEI2vkvhrlOXWipclXWomQx_o_Wys4A5kBA7PfDXSib1o8FFHxtPX5Cvtl4_gUKOTSFsgR-t_l8JGb_X7yjUaTVhELeC98ifkPIdzJN6UxodRkDzCACsXrBjcS2BoMMhQItEkzdIRA9e2qXzwKyRvyikrPOWf1dAZyGPQaMUasZsnU7oPIbSmH5gRgYIykXWeJeCn7cVCuKG8NxccT7eNtMghkhNjSgrpyf_yb69yI-PrFOozJhZbXuXRE5hAOWsK_r2lfNaqbX2ZDe1N1_AhmaarOqj9RPXwQHpXCZEM6rXu6KZ8kjQLbqhCVs9ZYdNn0CP628JwUFn6shramNNdGcm2R4Mqia-VKs4RnxLGtugm1LIbdAGvh3m6uZUJGjsKHK4hy-2yB9-3RvayeVhlcWvmGCN6x-j5GN4W4eSQRYA5f_ObOX4FXTD4IXpkCYML0NlErftM7QEvbAKff7c5Gy9X80nZgfxM8feh7V3_m_8nqBHTreqnAXRs6wLtDksDlrA4gDMsCuTS2gIkRpqwoK_lrqdh9pQxLDI=w612-h1136-no)
- 总而言之，模型本身结构上没有变化，所以也不可能有实质性的改进
- 看看在当前预测值内涵为市值占比的这个概念下，基于最新的（基于MonteCarlo建议)成本和收益计算方法，我们看看模型效果，（上图为无交易成本，下图为有交易成本）
![](https://lh3.googleusercontent.com/HSztx40HJ1Dy_GMn79dGu9-Qura4hcUl76lhvSXFFchoMoC4EYPvXujdLxD2_bDg2RwrEIbpnI8oVGgdC8UW6S9bam081hf9ieChuc9F4sbYbqYih6zlpQS3ynJqPuIJv8Kse4uKW0RZjMeFhfVfuEtjqJLYhXafeNpuD1-ALQbKGCCg8tkwETdvKWyfb5g9j7uPNe4NXKDJCXt9PCJ2QfciKwIG6R4w2M9vVuqG_xpwWqzGvjQ0U5UX4en_VrorrbKm1kK9JDzJ7UMlAY9i5bVvnCLtZirakLADT3lel6PufwjN1FsZtXWmQeXT2d-EiYxvHVQVlUOrV055uf9zrOFTks0fgfiP1OPQiNZyf8sLyDsrlCSOi0yZPgUndscUT7CLuFC79_LeyBTGCnvtJcqLho-yRAcxjZ-tnoiCQeXN4fL0Phoxcj9n88ki_lgZlcWoqyIDiUz9Kt7buG35wJ6km8pwL5xKcz4ejPGR0PHT3JRtQwHzeGeTnCtULRauKIIHxEia9C9O7IgVkRlph1Ln4eEcJwItMv-64LNpudxwFlbmZpCzdnVRSzTCmyGB_jXb-ZWEdM5fnMaTEmPp_gz2XNjFxUDHmuiLz5Z9HSj3R_T49Mq3QxPA=w2238-h1136-no)
![](https://lh3.googleusercontent.com/kgapNkoSAG2M4Jhj4f4lovvlTR68xFGO4f9x1a3haHwtrhL0uhq1aAkOsuxs2L7jwIcfSmfndg15OV48bLBteeTga29PZAdNf6iY7UNYK6tC2p8YWuyfKhWbPTofyZ41utLmd2BTSnDPORX45iVayfyizniRUQkWPILSYIbtnfFoi98DgVWBnLMOy_3WPckCOrZ55jvZhbOC46ZVH7mW7Xt-w0-ag2EYJfhWYskJLVayD-szulkzlUlQle2lg0aq8osHSso47daQKE_klS9gE2-PY2uDFcWJ46JJZ0oOIEDgmmjCxWFG7aeNtWE2hp442KTVYJyc7VtLSY6HDm6kg1G2gSrIFt8EOA_0NQHqjV4H-M3oNV52e33N6odDqbcPgrd6_dCdddQe3css6kxT9QCuJgup0Vm4TperaR40QGLNG_NhKrA32AnYA4ddxlYKpje6U9kCPMt7NyEKivg1J2d2YOYJR3w2E2VzkylRP7bSfgmTq92bhXhTLKBqOF22iQMrhdGyj5w735l-K7vIgK6S6b-54DD9v6TBtiqBdFk2yu3CEUP9RB9uZPxmF8tWhOYm11xNO5-UP8VjUgPtPgs0YPH3e_83taKpYDyWuYPHzMjOdRN8RK7G=w2238-h1136-no)

## 改变的
- 原有预测值y_pred内涵的设定：
	- risk_estimation的设计者，将预测值（或y_pred)当作持仓市值在总资产中的占比
	- 但risk_estimation本身并没有限制y_pred的内涵，我们有对其自由但合理定义的权利
- 为什么y_pred作为持仓市值在总资产中的占比，不利于降频？
	- 降频的一个基本思路：当紧邻两天的预测值，没有变化，或者变化小于10%，直觉上和逻辑上我们应该要维持仓位不变，不买也不卖，从而降低交易频率；
	- 但市值占比，这个概念细想一下会发现，只要预测值不是0，不是1，那么哪怕当紧邻两天预测值相同，也会要求会产生交易；因为，相同的市值占比，只要昨天的价格变化率不是0，那么今天开盘前的实际市值占比已经变化了，开盘后今天的预测值要求与昨天的预测值相等的话，显然就不得不交易了
	- 这就导致了更高频率的交易
	- 那么有么有更稳定的预测值定义呢？是否能找一个新预测值定义，来实现一个逻辑： 当昨天预测值 == 今天预测值，那么就不存在交易的可能性，持仓不变
- 预测值新内涵设定：简言之，用股数比率代替市值比率
	- 我们需要的变量：
		- 初始资产：1
		- 初始资产对应的总股数：1
	- 预测值新内涵： 当天实际持股数在总股数的占比，区间（0，1）
	- 当昨天和今天的预测值都是0.8时，逻辑上说昨天我们需要有0.8股持仓，今天我们也需要0.8股持仓，昨天和今天无变化，所以不需要交易
	- OK， 这个概念解决了上面的问题
- 新的内涵定义，带来新的累积市值计算公式，产生新的换手率数值，看看在不（设阀值）降频的情况下，频率是多少？[代码和解说在这里](https://github.com/EmbraceLife/LIE/blob/ec3005d43bdfbb0f2b76f62d1a8061518c4adb6d/my_utils/viz_03_stock_02_ETF_predict_return_plots.py#L198)
	- 同样不计算交易成本，只是更换了理解，导致更换了计算方法，效果有明显差距（当然不排除我的计算方法出现问题，请核查）![](https://lh3.googleusercontent.com/XDHPy0BHuuKbycMYna98g0KaKRGiajfLIbnhAMEoK5fCJdT8RlKWZK7LyFBtdPVus_RVB4RmsN-ep0d0FzOgVdGa_hL6X0fJSjJfb_BlUA9w5Djq__n9CEzpGkJ116yZuwK34j9E8bx7YaNZa_Ba0HeX_jC2zMSp7m1MOf4YTL5g7St-fBXgxjPTvvvN6mCVzdFEm02RhOkuso4j2I9INAufIl2VRe9Rda_KwNyo0RKR7_CMdjuw6c9sq4e3Y9tv9wYBL_CFyRSbjuQxrRRvom2BPlIRZ_aCDSWm_1tF33XfDRVHp68zuJIvq_jCWmVJ5Nv4KY8ls26VD-LPuDDMArHVZ1GhSxpg82EajvWjIGKWhPcwpjCXAPBpGlv3pvV_TSRIAdZJLUWLxfV9bxyR1Fqx70ixvZx27DVrIVbBCppycm2budaBnx5mGpwHECjMzVUQKxIHzEWfyRKNVlhpxIaHjKUEsmDDROyMxDitkd_EcJF3Pfzfj30GyeekdHOiO1IgEZl5nHMOnTYLJofnqE7bkeSkYcYRzlI7CUfXXGuBuYwomSPvdCxpaefEz2hcwXtJAYfc8UG_N_r9sUFzkTIt1jNFgy_5pNuvUERM75zBGnz1YksrceNU=w2238-h1136-no)
	- 考虑交易成本后的，表现如下
	![](https://lh3.googleusercontent.com/7b5xpGHwsv9u3NesnIGGAGILoCxtaqzkrKG6_2kF1i7IdkkC_I1PUpGTmwBn3OxHusNnjrB3qp0xKMofl3fO89pSFEysfgnnpRXQbUGsd_UkP1r06GSvP_Y_e2UfaB-5cUEk6TPc8dBt0cRDBaOn7jovxV1Ao_PGqlbtSPH1_8muDHQbebS7Xer4b_G5KkYKlMBhT_yj0yfyjqJ3l0UcUXOFik-Orh_B_m7Wn2XtpB6eFWRhMX3vgiAFZ54U3_DOP31gWCRX_m9QSArJenQ3w9cEGGOovYH2xHVQm955euMGz7rh8wG0T7c5FgHbkjm3JbCayWcjYDxR2EYRTnHmUB24OAthVLZ5Bq0pyV_uKXgbqwUgr5NFHqxl3EknB7PHMpfpr3RJXMeTIZftlxsmfJU6WcC6_NMSi0qAuKafRxVqwb0l_qfZcSqDI0w4RHqauX2_jab0z4L3iSQMBzLEi_kOUpOam7BDscIuisJe_HV_HxhTyHJEuhyk7FhJ4a5wO8BGzQKkHmhOGmUeD-aeKh2tBiQ1uCAL5v_9Q6edQNeGXDs8ooVBvJ-hGZJePiaPkw2F6LZzhSSSAReED7k_E-Ew25Rw3qNOmQrGEMWexyU8cqt2lR9nwj07=w2238-h1136-no)
- 具体如何下降交易频率？（设阀值）
	- 如果昨天今天的预测值之差的波动在正负10%以内，那么持仓保持不变
	- 看看收益率和换手率的变化情况
	- 将波动幅度控制在50%以内 ![](https://lh3.googleusercontent.com/wSRQoakBUbCUkt-aJZ86GyKbPI0Lc8-ETbTHXwfd04xqmAqdBO3ow-jhYnZsl4Rn_Hwb8g8jpAXCK3-w9LvW37aYjnG3ZmLDhuGTQfwoYFQzhin6Jf6alb59As-MdLTM3YU8o8o5vEyXKYdanCaSg6K53QuolXorSSRK_UhpOvoRUdkhKUf4j3xq1uFcFWR9sLM27z2Wg-O5CnPAqYRdW82bcmOrSgSxD57m3iG_3pEXE-MNzMoFUGCwE_yBlSoTUCiXSSF_wv2i50U6T83bJ5kUel6RfmJ7zzKNz6LNSaTGMvBZ1pTXu65MQaQbdWYPaABeoU-u59wueaqgKtME1BJ3co8hiqdlCCxiDScAM8tbBky-d8WKxpItJzJ6iFez3sdIvXG9Vdk79M_4jW2JXSKwzcvtCtKbg6qGo57zNlEetfR-NSJqknhiPyOqzD4rBSGt4PJHE0C71SgGQwGk4Q7FAttfTyw-M-k4Fdv06feykv-8z4zXQD7CGYl8JkaQOmq7D2LlY-qrGhz5cuKCIZxcr5B1BD0NNaHmjj3Pyuv1Kpg3NwafnGN5TKZNIBzowGmf9H_DsiEiKOx87mixyLy0e9hmC59zT40vVN0ImVFE0tZAToW4gGhp=w2238-h1136-no)
	- 将波动控制在70%以内 ![](https://lh3.googleusercontent.com/X0xTuTbGrJ1ktXJq2XMPFvQ6MGcRXHtdQkdMAa5ZBx5hUb4HgA1Q5DGFvyacc0rCYlMDaDJI3zo1qlLu_kiGj_Pu-czOveQd0i-rMRq5EEBTSinoJYDFYfc9kNPdwepmWgiDkDcPT9hhWuaKMvxpBp9bkS2wmLHlI81L9NLW2y3oFoMRPIh1wYCdtn04dluwSFvJUWBxon2gn83a2FWwGbWAC8uAXlFBfNrGqLW6pHPs8u3FEHEaEBkoeNjOMx3tIzXt0oXqBGjfGERpJDPqI_4tHWfmAGtr0CVQgQ_20bFiG0aBxbIxlRLlKB2X2ktXIX2VYXyrLSBTIqzNQYGwpRTnZ6mOFwUVbsCe0-NQoIYvrxeidTLk3oRRVba6GJzVhDVyPfipTVh8BDzAyo0KpfrDJzCv9YSmmbRv0Kuu5eBGpLzsioFzy2O-PaA-VO3XvhnfNUUw538Yj3pd_y_N4_MIoXJPxfLroExkW0Pn8FyaZBHkeP0g_IK5QajIjs23wHWy8CdicfEwhLSE2KT5gTlnu4KC21kl38ov81pSjkCehALtl4ab_o8BUi6ZDLBVx5dWAl9lkfno9sUUmn-CBkRbm1NRx_c5JOVRVgpaniH2t7mwtlDj2xGA=w2238-h1136-no)
	- 将波动控制在80%以内 ![](https://lh3.googleusercontent.com/XHUn3w31q4kgfJxufntkpx_CSYW9mBifzee2BqC6cWG-1o-LgVPP2DmV0xCX1uzDR5xP-LnUEoW0RtPtfwnuH2TT9LO9Y5jmD8TqjWJedrX_viMw2wakhRViBiYg7jpJrQoB8kxZaKOE7pG07VdIcnQHGsDd2sQ74Y7hH7Z2gumQMZClrgFxCbxTSWCFYNVdlyJaRAeivKd8F_lLbhLELJ0wkIVVGLPq24ZOkkhmTxGbmV82sIvuIfYK9YgYyP4bGD5gt0ltiqTT5UMCRayFjOR0APW2N56saOLp12VkfPTqf0f1zSxibRXf5hhC0G7_aXCWCCMqolsJfUc9SPhIvXkr0N3_AG7nbLDZN5-uoBGFttj99A-yM3I0t61HlQ895I9Lj8cYJAG0mWntEsa1N_3AAf5bz7EiGxaCSGIcvr9zygw-nbxb5Qbnf1XJrNrF1ibaTMKKl67Vc3l_LwojPYpoX3acWB8vKluqIeQKz9ZnevILKSPYlUoZl3DToxDNPyxX4oum1SGpxITNgVUqDo1Q_uW4o119_No4tiCZX_y1Q55CO28-GXLlS5E5AudGnCzB2emLeO5B33PzDdgI-g606WFlt4NPOJdHcn9BlTFmmtBx5juECN-T=w2238-h1136-no)
	- 将波动控制在83%以内 ![](https://lh3.googleusercontent.com/S6NUr-1-Kk724_V9yAcOwEpNKk8UbPAXgab9BhU-TiElI8Y6Wz6675xQ1e3XiqX86IVXT5GIREKfeB7qZ04YeVZ_qMWMZUGXHOIQQtJMauewcGTEnpwkBlJ1uRU8GKh5-Gmt_dFbOXEMvEkmLvFpcAvtXExnbzrrQ5KGTrmUFtfAwJOR_7Q2BWGpWul3gPEyYWbAqTBMh2ICz4lYhdMKIfbwmxZqpjaCvMOyzUx8yTW_fKPWnIa49O0oFS2tWjdXE0SUQOFfHAdQGBjW_-wr_fkDHA_UdDja3BfwXwUSbV_REDf3Ruuecwormpo3ya25BVlb5brvygc1TnxAdnK_08Sdzx4y2FLvI-Oxx-RjfdIiG4Pk_nEXqko1l30WiacMMAFMd97A3GtWNFUUMqQsn8bjQ7IDdJI2DXOOY_JJ-9s4AYzv5fRJVb-0Uux9nlNF5JvHfwOm2gSAPkGjUxzdxzngvnhDD-KC-O1s_MnH_1ZqC6gPA1GwVPVVHO_I_miymyFpKEVzPTaWL-KArMObNl4Un6b5J_NBnso2FG3h0FIzfspGjuNLORkTaV0s1I9J9gXjIRKk_UHYfym17DlgzBeUYC2P4QtgiWXfw-h8xE3xAkLrnzrKU7sm=w2238-h1136-no)
	- 将波动控制在84%以内 ![](https://lh3.googleusercontent.com/phm-pRxEuNvHj8DaGN1qovVkzV_cLFNeVULs9lSyz19s2jKbAiqFqORGVqL3Kw0kjXkQ5U0tUNOgZl0bwiJBoho5pAQ8AztiLXQQ-RV12kOSG7W_CzOOJcQDkORbBVMjvbJYLW0YneGKCW10zLF_4HRqav3wpvmBsqg3IY46UIKr-6uAmCSl28o0jcIrATmKKPB5Fp9Nvjhl_9CoJeT1Ox_VoWDNkBt5uVn2Z0KQRAvt_--x57Yjss57UE3MeW67DZ2EgCxZDkaqzi3bS5mJzPtr5kVqRZXp1uwd93pq9NSRbpsCwzST75el1McZaD015SLFjhGmAbovyXTCvuvwIk7MduvBoJvuAgD-1cOvkUC1PPuV2h3zMOtEIiruKY2eBYAtV2awpib8k7DkiRIyo0Ae6OsrBLUqdRVuaqV1pS6Z3mEpB_WjI7IG3AyefYXoiZpA2CYUCudxB_eWpm_3_HIwQr2EHp9vKMv0ZS0cXf1V7LAWKDd7LQt-5YFb5BYy0mQtxR-leus-Tz7mcOdqNji8Xo_x2y-uVGI5nVaQM5_6Cv-orieNKQzPeeJHXoQArK3uRevXANDBqVC0MgS3ELHL6XE0XS0QPHwKlXHp6uWIS3HkskmvfXiz=w2238-h1136-no)
	- 将波动控制在85%以内 ![](https://lh3.googleusercontent.com/DU9wmJSv83UXj8REQ0vm6E1yl89xgGP9q-E6GiTvncxbZHpudHkqbWvwSbrvBDCnNXod00GEcraaYg_w-ziYF7gS2OSDB2VTIZhEIOgbdI9WU3x2O7vz1yNTWyW0_8JrArnpsrayWeBSFeM0b9coyBQcP8ywJnzHn9XMlpcSn1spV6yTTbjNAnT_hNoAbW3gV6in9mHvggLCryMEuWmjLoQ5AR7OvbDRJfpm-KPtRH2r6WpKa4076rcFnz6LvMpyxnZWclnszXMTe_8-M7Z4b8GM9wqCmJSJdiHiVI7hn4b8TGG_t7r7jZF_HVOgpbf5SYlatjOhfIEHdp6_OSn3vd1xYjrIpfJItXk80X1jJqp0jGYmDfNGgpVJpOaIoUJ5jhPSq6Jtygq4ulQeYmb_w94L6wNicH_JVEdmfca2LK73xWNVPfdOUmyMi_p13eoRCflMb76j9b0Kgv2tXgSW25WbR9hxwr-F1dhhnb3RZO6NKGxFfpqmu4kk1BqL4lIcRUG6sNadOoINZOTRmhzs70fIsBdUM-pTKiFrMJh6xIz7fZeUadBWYZF2MjHQ_9xsOTO7vyYFk7keiHp8yokZoWcEfTq8JwjqDaVFULQaYlLUht4GS_jz3-P1=w2236-h1136-no)
### 上图的变化是否有合理性？
**变化特点**
- 随着中间的预测值被过滤的越来越多，模型表现效果整体上在变好
**合理性的支撑**
- 预测值（处理后）的分布：
	- 多数预测值，向0或1聚拢；
	- 意味着大量的交易成本，产生于1和0附近的反复震荡
	- 要降低频率，就应该减少这两个区域的反复波动；
	- 意味着，过滤噪音的区间，在（0.1， 0.2），比较合理
	- 但实验发现，如果将过滤区间上升到0.5， 0.7， 0.8， 甚至0.85，模型效果有更实质的改进
	- 为什么？同理，更大的交易成本，产生于从1变0， 从0变1；如果这个反复高频发生，肯定交易成本巨大，原因是模型过于敏感，接受过多噪音；所以，提升区间到0.85的效果，目前是最好的
	- 同时，区间从0.5到0.85推进时，模型效果整体是在不断提升，似乎也有一定的理性支撑
