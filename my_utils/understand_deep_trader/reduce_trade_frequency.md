# 如何降低交易频率-尝试3
reduce_trade_frequency

## 不变的
- 沿用模型：输出一个预测值，只做一次sigmoid处理
```
 _________________________________________________________________
Layer (type)                 Output Shape              Param #
 =================================================================
dropout_1 (Dropout)          (None, 30, 61)            0
 _________________________________________________________________
lstm_1 (LSTM)                (None, 16)                4992
 _________________________________________________________________
dense_1 (Dense)              (None, 1)                 17
 _________________________________________________________________
activation_2 (sigmoid)       (None, 1)                 0
 =================================================================
Total params: 5,009
Trainable params: 5,009
Non-trainable params: 0
 _________________________________________________________________
Train on 84332 samples, validate on 17500 samples
```
- 损失函数不变：
```python
def risk_estimation(y_true, y_pred):
    return -100. * K.mean((y_true - 0.0002) * y_pred)
```

- 特征值：（?, 30, 61）
- 目标值： (?, 1)

## 模型训练状况
- 只训练了300 epoch (次)，最好能训练1000次
- 从损失值上判断效果和之前的模型（训练1000次，验证损失最佳值在-0.15左右）没什么太大差距， 见下图
![](https://lh3.googleusercontent.com/CQw-U9vireeGK4-7ljRVw8mv8tIdhiMQCP-Lts4J2siMCCMRXowy4125Zpse5egQi1HaJvj3xOKVndvN1rMLb2zkZ-d9bd6yuGgaCcPDfYzW9hxt6HPEBotAskeONHlGidK151KxhumI5OOU4YJdWaaDiDjquu-bZ5M8LHCMrt19aDD1Hf1k2Fc283xnrGB1TqlITYkIJO4YnArV1eqW0evD2BmYy-hbtAlGymtDHfIeBLGExs4fnx7o1v0V9_v2LjO9V_4Vi8bkmzzv-CtqP9ReL-FhmtfzKIG3icaXBKbbL2gVGDy-r2mmrwQTvtx5ylAytgd7JxIIdB66bf-m7K4yIqIgPvQ7TAGTOEErAEtawCiiD5XkOPb_qlrQa3W7nbOGjxqal3PKOTMiSHGX0PWN83gjt5cO0wXO7QdDRpnk5i_9Tbbvf3upKCatz0On0ROboJTuZj8pa1dVY6sxL3RcMjiDDMu-Conehob52nePQi80mGSCD1MTKe-x3iKyvXlMGDHM5GPxtGAJJrir60lhsMwcYAPxFZ8DzcRdlbJjqqa_8g15OFf-2gLVmvTrFsXGLPCQlYt_a-oqRb7Cfx6LZRzgYtf2NveX1PKGGFeh5HuZmhlyvXBn=w686-h1136-no)
- 模型预测值在被处理前的分布，见下图,(下分图为处理前的分布，上分图为处理后的分布)
![](https://lh3.googleusercontent.com/yjmnE6AlxIsuQrf6AYepbjXIZ0B5v54lhsm1yHAvlVnACRBWoeYJv3GxfeVq61gy66bBLl9affVqBVLU-rAZpEI2vkvhrlOXWipclXWomQx_o_Wys4A5kBA7PfDXSib1o8FFHxtPX5Cvtl4_gUKOTSFsgR-t_l8JGb_X7yjUaTVhELeC98ifkPIdzJN6UxodRkDzCACsXrBjcS2BoMMhQItEkzdIRA9e2qXzwKyRvyikrPOWf1dAZyGPQaMUasZsnU7oPIbSmH5gRgYIykXWeJeCn7cVCuKG8NxccT7eNtMghkhNjSgrpyf_yb69yI-PrFOozJhZbXuXRE5hAOWsK_r2lfNaqbX2ZDe1N1_AhmaarOqj9RPXwQHpXCZEM6rXu6KZ8kjQLbqhCVs9ZYdNn0CP628JwUFn6shramNNdGcm2R4Mqia-VKs4RnxLGtugm1LIbdAGvh3m6uZUJGjsKHK4hy-2yB9-3RvayeVhlcWvmGCN6x-j5GN4W4eSQRYA5f_ObOX4FXTD4IXpkCYML0NlErftM7QEvbAKff7c5Gy9X80nZgfxM8feh7V3_m_8nqBHTreqnAXRs6wLtDksDlrA4gDMsCuTS2gIkRpqwoK_lrqdh9pQxLDI=w612-h1136-no)
- 总而言之，模型本身结构上没有变化，所以也不可能有实质性的改进
- 看看在当前预测值内涵为市值占比的这个概念下，基于最新的（基于MonteCarlo建议)成本和收益计算方法，我们看看模型效果，（上图为无交易成本，下图为有交易成本）
![](https://lh3.googleusercontent.com/LLGaW6L4dymCc_sav32qADqoYdNDblj84-nlVIfYW5hzO5QDxDQL13R3wHnxdx4jKpXS483YLRGEqY2HVfH_C8ZQvR9-S7G-fHpbk-UNV_PBhagPLWgstdNFiiLnKXz3NnNBx07_mvT51mlktNjMlZxTy3l06n82KQGQpw4tNKKclBVt-wala5QD_xCcXVM2hiKYDGTi77q5mljerOCXfMi4-3pnV0WTTntt0t1uXMCQ0yX9yKyYnxMqe0DgwK9AXRudOrG6X58TMQLTEV_IwBXUGyKiGGF8UuXjNKMexh7CrPz1pm-RuIR9kZLgEFc1Hd9-EovIBzgZmAak-Wuic0_TxynY_0kXcTTZUAVYQoZpGzZN28G-hJCkMMVjwfjUB5bo91RiRLw7qon6Yr5KDeXNZMpgZqX3CGXYIdfkhJUd54sjGbxC69cfrFIao4L8piqmE1P3SGi9e4pvETjDCVDM7gyZf9nm2mX48U-KQWPOiB5VxDsfQ7xHeX6hl7sAR-fUszVgBgyHpDjt3lMnmsvsrXRCbqMKV1SP4PEgSf-sYtW3mhy9mHgkEuGt0OJBp2EeY9KdLJ2wH03_VpuJWW6f3Mn85yjcjgQyS1w-4EUZf56zIpzzinzk=w2238-h1136-no)
![](https://lh3.googleusercontent.com/p4hmnKOZ6-JUVtQpIRbWLLrQS2U0uevY6-vfxQKMUbwiUmIIlANeVxUdO8Tr6YakfPkS1Vg14AIeLwb5jGWA_bk9H4oWp-_CcZ8K1In5MK0YV0LwdCu9Ckr2By7QNiEHXpXHmRw4G0wLPLgRTEdWXCx4FINBThdGA8UJ9x5sDdtACnj8igW7aUAZpRKa9S6W-QgDUAQZDGAQCXGM9Q9JLBwdvTYvvIAHaa3_vROZGYtzwGGGk9FhnxEvYEQSZ2tkeCMz9bI2PtTe7bEHCWLxw8-f70xsqpJK_aFDPiURG1oAmgm4geDTfALa-sX4wIgEEIFJxqVu98-_fqbHgim67dzavsqJNnCSUxwqCmpWKwO3D-gTaetwNF08KVzoBBijIV0MWtCMyOQ-Hc6xJu00mHWzhlwpoIgQEI7ndvLoUeMzPDF9Vebyfy2e4mLG5KfhLTJ8K4LAMN9zVCthWs_c9nbTVDR4g0ViN9IgxFijY3fsB6mG8LPwSS9rlsnBJpjSdlwSi7ZUvxhMTquo2XPmy0DZXx224etNZQsroihfwSBX6dljL2JOWlS82pQoEjRlAsK86W_2VdYxdDCVpSLRxWvnPpIIINh2Yg4UYeRh0_uZwE5QV7z--v1i=w2238-h1136-no)
- 我更新了MonteCarlo建议的总资产的计算方式，同时设置了阀值，[代码，容易出错，请核查](https://github.com/EmbraceLife/LIE/blob/master/my_utils/viz_03_stock_02_ETF_predict_return_plots.py#L284)；下图是不同阀值状况下的模型表现
	- 紧邻两天市值占比变化小与50%（两天相减的差值）![](https://lh3.googleusercontent.com/wCjXegaxLHSoqP2rbXOqC-xH64lGTLOS69Ybtzt6pWLQVsX7JwpmKhA9joY_ATkLi1C8DNEJdL8IvESEarCcoOWqsoiTgU7PXMrhBrU51NBoYIOYb6eZqVGALVZBPavdamAzZxpAuQVioCfRIfc1LOVQaithp_VGdwKHofAOIDPb8FEjwPbTdVCBkHOnJKLSi_W0XmFlhT_lZ_N719q6MK685l9cMV-xq19zzauwcIGSA9yD1IDTNfVk0WJAw64aBlTte9oXrbPrV46Jc4qLAaVR52QvgUDD8_kjd1wcPsUogIoz_q3_Ks7AFqYXtuTkbyMad9MDNeO5R5wIrwaMeFjyQb3ZBYPfoqzA84-jLGcVrWtwUF6MLvH0gj5zrXemwRf82Yh2sSR3c9LH1h7mfve36UiG-kS5ZTBoVaTcLn6HjePq33NGfnO-PzLicwD06Gwx8yd0yrz_lE17PUB-h9-TU9bpM4EfbTVJnKxwfUMk1pgEDr9qhp6aODxpMZQFve83FBUEEatxrAuxy1_r13Sc2hBepbbrOFjMVVhFfhXz_a0wao8KPdqP6k64qh6Xm6k3xHvv-ZZMoE5kbz035kyyepLIjONYENC9EGda4O2xASwc5wOgALl0=w2238-h1136-no)
	- 紧邻两天市值占比变化小与70%（两天相减的差值）![](https://lh3.googleusercontent.com/5RjTlhAfVickwY0adqXbZh_nlhOQVMgR0yot9eYVxs78y9C0YKMw8mjszW_xKSv-jIviNtmgaSEDRBtkZhYNyPr24QyNXrKiEzeu1o-2ROi9-p54TTHhSDxBFcNm7DfaIFMTiSdOBkfIGKGm18LnTHYDjeNlL6zeWpZ1yeA3w_K5q8PkfH4Dq3aTr6atmuBY8pgCr14m8DX46EtOOEPy-w_n2vE8LCKdo7DyCDpvYTHu1fRF6LiLKB_oIsQUDw_tndgudraXI2-O8UrrgA88Iq1CjkjGmo8egpYcxNffMl58UYLuMfBRGDdqKBWjVKj2gJI59x5TDuOaGAiVH6h1IS4T1tVUZXQIQCTT9Q75tSk_jiFrD08JjTEaiFmX19DLFUSxNCIzqNwxYt1S2AtSYTMCxUhryWOeLKl3iaj_LK6tKn4mrqjsCTk3p8G1XAZt1wT4d4ZI8WKI9txmWdgI2Wgzv_zEbHniDHMT37al1RTov70qNeh8aJ8Qd6BBn7OGYXYMr5e2fng4VJx0PchoDvjlLlU2xX7x3OOZoCQ78jMFZMTwqutOzgC7pJtrjz3V8AGQ_GFtr2m7pxxyubG36IOa3bdL1rRY2_reX-sFLvUrYZc8dibX_6a6=w2238-h1136-no)
	- 紧邻两天市值占比变化小与80%（两天相减的差值）![](https://lh3.googleusercontent.com/bp-7-2QbY7kQqTK69_lY5DT9UgTzInuDH0V2v5mwebxt166TavSjvEOrYuA0uAZxLQ4O7wJKqXIbcAXvk_O0AqYGtlW-p1hYhlyYq4AEoWIXPil-jivoh07hYPUyQ7ZuTXSe9VZlLwuvIz8i7JZdcqIQHIHJSruVQCHTqhrE1uAkt7qHjU9GsuJbMPPq7l0UQaPGTQo-GMESt6mOJ1HeywrLrCTogaZmtiO-njQ7w55-G4rin9KE4VH9gYwu_PCMOj4K_q1M9qOriNVEzuY3StXDkJHoPwgabBOaS4mIOWImlkdp3oTLCD4-wxyj5azl4ruH4pTeS8zZE4iKkiMnkVbWogtlS0ZldLnnQgg6dG0jmxxPcL6PSKhw3eRAFa0DsPrQjtRQBtNKLRa_F3w-XMeHKXv8kn0c8AsWN0T6JJHjHnfEZheGhfS33GjvDEwYne9gDVjlqsnTmQ2_kSlvRjIqrYGzdoBCBH6ycVbpjUZZmGc9K-ZgzbhwQXpLI7HDgApdMtLjgATTE0kgUOciMGwVWhYuIfE1Xey7I_lDPRkjDRPFMVKIEoKagm0GReQnaYuLjJM06PVHbLJKjLXronAktvNyaF34GmiHDnhxmLPwXW1-9AbpyhLg=w2238-h1136-no)
	- 紧邻两天市值占比变化小与85%（两天相减的差值）![](https://lh3.googleusercontent.com/SFQHZ90aP9cyIZ7Fw83W7U-bDA_FWy9tgPktP1Zz_ccKGAztngmfavtoO14Mju5B_xaL0xUKKEq9wsEnEMt8WXfsZ81KtMXRF0Rigjy6uF7wCKxTSemGi2tfb178NV0k5Sw7kUvh1x025Q4bEjyQ3H63-7U8UDWbtNYH_-JtOxXavpCAVMGjek5Yl-2OEYq0rM8ytHykn7YsOA4aPfRxVkbQEqJttfaEnuZyYEPt5vjKV7je11B8eBczPJ-iyF45SofB_hMTYZLsIRDMHDveH7STXGGjhCMFmneFFwuh9JXkN2Zax_MiIRWueDV0OFFIBn7RheaM7pG-JCXciIGzAooRZL9ALCSLwKnZf6fK4IYBdG8V7dHE-dZe7uSuxNtyEP7NU2d3EN9IF5pGN90jXdPNJXQrhfrzMBFZa_4mE-n9y5RAjN0aPkMMFXZIhaEZ7vrpxlW-U-Gu_H-4Q4OBtZzS_XpjqT-gHxop-QLxijVW-qPDgS3Pi9FV380XLO1W1W6GhzfvfrUwg2Yx1EF5P9w4c_5Pk3wfOOqQX7SSpkHCqFZjq-9F-GBKD115NwThV7LyEXm3s15pTSudS6CymAAFV2Wei5NSEIHpoboxJwQI6V7_ksgL20R1=w2238-h1136-no)
	- 紧邻两天市值占比变化小与88%（两天相减的差值）![](https://lh3.googleusercontent.com/2Hp_yyt3YkwHVVWnwcvTSj8AiObeie6DmjTZw5HOMfjSS3W9F6R36uyiSQpA05au737W0_sP60J-WrayGxbCBT85jmGO_ldNrBP3qkwRIjiHXUC-cgg_JW5T6x3PK8ildT58JWyAhojMtZrMSE1w72vCDTtj5EjWVE-p45jWt-qWR8ghG29lrLzTJ1dBs3Q1ECDy5widvG58EWjg9Biwf0cxrWliy7Kq0JcJ4_vWSDrKI91CJUI5Fe4lt3AUJxwZKNT17yvLAGKNEssXoaBb4-eXiZ4LvccoV1SGGAtN2kIBb_R57kHsuGxZlFLikeZ3lM2YLowHiztzj9SUNdok7gYUVBv0WW19MUI6c4cPOC6UgtU6yuGbemOh0IoTIBvOSv_3LDWQu6AnnmPfnwSEwMITfNWKTMG8gEzLo257z-MwpO9SeoqNYaZQjD7S0qFqvh-yL-OKtGacpguhwUJUmiLOweZh-RHDhC_9o06q0ulRz3FOrAZitGuJRlqLekk5EiI1qFZ7IKcp37xghP05tacVxyr5tjvtiLJmdSxK6WzpJgC4q8ooNJcgPsTTCVQ-eQe_MPPPnE6nk7SLMLpvkucY6hbPinWheBgdM8BqTe4PKqtYPkzXBLZf=w2238-h1136-no)

## 改变的
- 原有预测值y_pred内涵的设定：
	- risk_estimation的设计者，将预测值（或y_pred)当作持仓市值在总资产中的占比
	- 但risk_estimation本身并没有限制y_pred的内涵，我们有对其自由但合理定义的权利
- 为什么y_pred作为持仓市值在总资产中的占比，不利于降频？
	- 降频的一个基本思路：当紧邻两天的预测值，没有变化，或者变化小于10%，直觉上和逻辑上我们应该要维持仓位不变，不买也不卖，从而降低交易频率；
	- 但市值占比，这个概念细想一下会发现，只要预测值不是0，不是1，那么哪怕当紧邻两天预测值相同，也会要求会产生交易；因为，相同的市值占比，只要昨天的价格变化率不是0，那么今天开盘前的实际市值占比已经变化了，开盘后今天的预测值要求与昨天的预测值相等的话，显然就不得不交易了
	- 这就导致了更高频率的交易
	- 那么有么有更稳定的预测值定义呢？是否能找一个新预测值定义，来实现一个逻辑： 当昨天预测值 == 今天预测值，那么就不存在交易的可能性，持仓不变
- 预测值新内涵设定：简言之，用股数比率代替市值比率
	- 我们需要的变量：
		- 初始资产：1
		- 初始资产对应的总股数：1
	- 预测值新内涵： 当天实际持股数在总股数的占比，区间（0，1）
	- 当昨天和今天的预测值都是0.8时，逻辑上说昨天我们需要有0.8股持仓，今天我们也需要0.8股持仓，昨天和今天无变化，所以不需要交易
	- OK， 这个概念解决了上面的问题
- 新的内涵定义，带来新的累积市值计算公式，产生新的换手率数值，看看在不（设阀值）降频的情况下，频率是多少？[代码,容易出错，请核查](https://github.com/EmbraceLife/LIE/blob/master/my_utils/viz_03_stock_02_ETF_predict_return_plots.py#L209)
	- 同样不计算交易成本，只是更换了理解，导致更换了计算方法，效果有6%左右改进（当然不排除我的计算方法出现问题，请核查）![](https://lh3.googleusercontent.com/mD2LHECAL_u5E2U-SeojP0sdDu5mgGz7fC_08hG5l1D1Xo_MaLIatBq3r4VP1LrGKL65Omk7oJc86ZfFnLXJvAqyEJvBr5qmQjT-yORPfjZaEZeWN9ddXgfmhvMD6p6LI7gG7KDKm1QS_2dP-YlmCzyc7km5xmqbpFYH7ha2j9kro6URUfxpZSY-C-Il208wh1CC3q0aYxQ7ZfBTNobd0Ln68zIq_s-C7pKzKUPSTeV2QDud-LYffc-eojOkKU7Tk6dJ3kowIjH0_YbzD9N1yPGCz26QXUEtdTjNpJP2aBFJuao5XGdA4XKYmHW29MyubT34zo2x7r2H8w8KhLAoS-xcGW7_xFebAS7_tB7kck_BJfOkIElknF_LjXqCaczXZvaAZzSlJqUPZGr4LT3Q8TtQ0tVeqqT-xM-jRJeNsa5Hy04s_gq6c8ttn6r-opUMNP2fTKY5mosvkrlipZQeMifI1nTlaA3EecO2tbVjsiVbg3VI54he2Pzpy4tTU4lOX7IvzleF1L3lsvIhJeXN1Ba_RKzlsYzFLeHSOlejx8FAUUhGEuRn76ble4ZOXl7iTcFvszVyAx7aq4Mn0flv2XezhpNnimxbTFxs2Cb5qeTOjSzqJnacI3fy=w2238-h1136-no)

- 具体如何下降交易频率？（设阀值）
	- 如果昨天今天的预测值之差的波动在正负10%以内，那么持仓保持不变
	- 看看收益率和换手率的变化情况
	- 将波动幅度控制在50%以内 ![](https://lh3.googleusercontent.com/MQIUsT1XXCxQElCY15IsDWf9URR9vIbjHHqZEQRrpQTk1SC5Ktnx6vOxPnzy2ytoIviM--Vn-UYgrlD-hoqMVn9kZ0P-cGJn1pqsw8hfDhUq8h6NwIlXnv2s1HwcS758pThubtwyT0EidWokgqA7dApW9DWgMfW16yjz9fc51ElVARZugNDpwpfaptvsXmU2GgPUJSVkHFEuy13_h1rIga3Yb_r95pHmYVzyktajxX1evUeVhjIludE70xuA1T5LWUqzKm9pdZMGOPwqY8-_dWXspt4Wr0xJyu9DgkZpCQpABZ5PmduuNvVgFtmpmFLBD_QumfuqbjoFBPZRr4wlWf_hOnufkDEDKG1usuaML1oEJHD0gZEZCHdQwB6XAdecbEdCcZrcwQu8_qaIoE1D6tF3ZZNDAEQwA_P9lyq3Mb7EdILLYSvDKjTul246BcUdXNzhtYGw5OActVLiLWWaqnUK56BNHZ-yjAY7KFKDW-1jpH4DJq-lSNQLkTuXX-O6q3QGt9Wp0NM3kQtDQodAGxvRwY893V8N6VtePnju6YtZFZpqR9BBHzA6GueoUwWG4KdQFzK1QsGMgRtr0ajXPYeM4CYO3eUFVwvFi7YsVcY5vb4FcD3BAgSY=w2238-h1136-no)
	- 将波动控制在70%以内 ![](https://lh3.googleusercontent.com/HOIhyiAjZU97MKSFt8MUzN3h2NJvE5CxjfSoKgJCj5vkIdWmqtAAtm7V0Q486IVLbFHj9XvUvdUCzX9r5tXHL6bevVjQ_XPL3jzLaDiDmm-P9pfc6EgYq-w7dnvaA9479ei9B2QMBdMXSZexFuMzpv2sP8sVc4Mt1BVkKzyEDSn2AwPFyYEBVw3I8T9RBZVRiUMR1iMc2Gq6vNMPGvNmsSXXR9t_-zvg_8yev3ck2y5Ho3ifgCm-6YEKdgzqjVgqu--ie9GcX_Q3jtuAAboH2h5ndmeKZI1_EfzCbJCPo3wn0dZaERDOCLBaKT61oL6hDvQQFaKszmUaaMxuD2wZIUT9ZEtphgwlGFCZqvp2e6Qb2hbkDmWenykm3AAZvOh4YoCm8D1SghZdY0s_bMISICIu63aatkil768N71ku2ecuZyLvKQogRLIAddNu9BeRtfWgmWJ1mgMvPGnLieyeSriZmL3db7NJtjb3PkovCGdW4904K4F6CufWNlYjKH25S1XiyEy_jjE8-BOyDyBf2hEDq6vH-wm_G2xSIiQJY4k4gSiODSRRcDhMwyhTZAHcFYqjjjeTFkhLATMbiRFoF_q3nkgZ3LHMZMpb5Rv6YjY4pUQqsN3OS-n0=w2238-h1136-no)
	- 将波动控制在80%以内 ![](https://lh3.googleusercontent.com/s-qvGvGH28gmP8Zj62ZFwTsAOLxKJ0ey-ojfK9nuqh-TjOyFdrT_nYfgpbGwbwcg2FoB66c6JtDQIAH2Sv42--p6eLx0xUIDdJn414iNK1jnt1SRD_zNCHSZpaxViRg5BkKWpl31zI02lVpUusjtAFuLUejO9KalcVhkw55FtYtMViO6zO0FuK7CExprmLXPj8b13I04jwLjdbMP7ZPND2WcL0VuNswosCryUr0xDYrFEXsI8f8h2TjkzAhQkX_hPfzxRWN2-Mq1oB4dCAaMEMTrdqIvi5MN-W-pgOEgGJGnawW46ro8e9f1FzJiwrLR1DZ8PyteA6E70XM-Mf-pNLG_5WIiur_4QSiUtL54Z-_sZ23ZCnuEBXlv0-9QODm4DCtc6SY0vXXViBJhAQl9GAWoNtK2tz2eoTqkrbEuG0i662QjJTBp4r7jyit5CPbRg4O8K7f-mFL4YrWcwckkljHdvr8pZ78si5G0UDQNpaQZIWW9vSrC7MDKf6E5ofAIlBiVtSI3tTEapk1R2WFr1G0VbxHuDVYQNLb3oQnSSv-MpSQ6E6TEdGJUpYR814fVE9yZxKKnem_WbTf2HPj5IWpBMueteqMm0ze9ti9u4H-2912K2WpRAlzM=w2238-h1136-no)
	- 将波动控制在83%以内 ![](https://lh3.googleusercontent.com/yKNwRbQfckWuzD06zgG_vXtVhuS4XQEyhgvwPnATpJsDJdt7vrwiQeoGUTlD7JUNwrpUsUkgSU1mO5m4lxdBuvfNHASvU8SPuBV6npM4eTtLAFONHmbD5JAslZ7LtnnX0RofUo4I-dmG-XHz0mrtWNwCRwswf8WYfpQvbxE4PzK7bQu_OZWB4Vlp8ZYYCF2BFiU0TH-O5R34WxtHfK53ejTVC77wwPMhSVzBM1ey9PupMXOHhlHukI5N3vbBymU-OLjvUlgas3NVrJBpGYSlAGO5POG32pHInUIIlrWIe5yO4xe2qT_F3yl4g9skA8uGWmZnlXOFxvfx1ZQTSgH7tRX1toO4Gkn0p69ymBDzIi73kXGS7q0hgDi6ebdZ1q0KELExN5VorJiNCpRhsv7T9mbCuXqFqua5IiEvBGheTee3NUs0JDR3Oxghy7dtIjxl9zjsi95eZ6AWeQ2qkZppQ0--s5-yIsaldHyNvEuRJYHOqprk4lbEjGr6QQlFEu3Hepb3CNuZhky6Zm84_6-hxg0VIhpiS1_5x6L-QBwO5lttElmwBG8IVKq2ph4UwtIen9qe41U5VuX4fZNz3dCHsLLb6dN_5c1giIK9kj5uIP_G36oKh0kKOzpl=w2238-h1136-no)
	- 将波动控制在85%以内 ![](https://lh3.googleusercontent.com/wxEUDphErgOuHMhIr8f1Kl8IORyIIQ-xGa1KQjsFkWUfjMjvLt1akZ1O50d_YCTizjsz4t5W8r82JBrRoYfZ58o3prZqfzAP4jqN3SFwXGrcNtLui1UtYV0svgLcWVEaXCF9ulpm1Q9938q7MRRvxDpUf8zMbRpnh29SBL3PBeKip7LS7jKLtErFCV4Vqt6YjyQengQQtQN4t7Iqyc9tCsByXwcGk9ICoSGRri_OqVtBY0N4NLCudQlOwqdbiIzrI0rWCV73YyG2SmopiHYaJSk6MuM___EWPdXSG2Tc08lcblGnOOTa1BHlcLSN6kzxAVjpPL5wweOO7QZONqZssktznOWgM6_TViA9j3S2eaSsqEmMe8OobwXqxvEb5svCF0r8SCyoyy_rJ_SC6CXbxpm_1Lqw3-MSbpcob5rpHrRwkQVlavMq_Yz8aYtCOEDEXOGiBZom27-oSvO5zUVQmUpBNtk5FG1_mEg1qqJZNIddqDd7dE30Eq3bQIm50S_g27IXO12Nm3TmU-bbRiLgNQr_RjSdGGVKEXhdjNLqOt8kSZAtflOqJ4lbiy_VCdzdFnu9FVBkkqh3v_Md949Kc_HEcDNuTKi2JCZhsGTwXFUDJcFtYvCdyUd_=w2238-h1136-no)
### 上图的变化是否有合理性？
**变化特点**
- 随着中间的预测值被过滤的越来越多，换手率，最多下降25%，模型表现效果整体上在变好
**合理性的支撑**
- 预测值（处理后）的分布：
	- 多数预测值，向0或1聚拢；
	- 意味着大量的交易成本，产生于1和0附近的反复震荡
	- 要降低频率，就应该减少这两个区域的反复波动；
	- 意味着，过滤噪音的区间，在（0.1， 0.2），比较合理
	- 但实验发现，如果将过滤区间上升到0.5， 0.7， 0.8， 甚至0.85，模型效果有更实质的改进
	- 为什么？同理，更大的交易成本，产生于从1变0， 从0变1；如果这个反复高频发生，肯定交易成本巨大，原因是模型过于敏感，接受过多噪音；所以，提升区间到0.85的效果，目前是最好的
	- 同时，区间从0.5到0.85推进时，模型效果整体是在不断提升，似乎也有一定的理性支撑

### 猜测与后续
- 回头看，该模型输出的交易信号，其实只有两类：满仓持有，空仓观望
- 降噪降频的区间越大，85%例如，如果模型效果减少有限，说明越接近1和0，满仓和空仓的准确性越高
- 该模型（基于sigmoid)不具备提供半仓选择的能力
- 如果我们只做满仓和空仓的交易模式，还可以在哪些地方想办法改进模型呢？
- 对这个模型的期待：
	- 如果只训练指数数据，用于ETF交易
	- 假如不需要有非常卓越的盈利能力
	- 但希望能用于实际交易（有一定的盈利能力，但有较强抗风险力）
	- 还需要哪些工作来让该模型具备实际交易的条件？
- 下一步工作的方向的可能性1：
	- 进一步降噪降频？但什么方向呢？
- 下一步工作的方向的可能性2：
	- 目前已做过的：用三年前的数据训练，用近三年数据验证，用近三年的数据预测
	- 延展数据，看模型能否学到更新变化，提升效果：
		- 训练：用2年前的数据训练，用1年前-2年数据验证，用近一年数据预测
		- 训练：用1年前的数据训练，用前半年年数据验证，用近后半年数据预测


### 严重漏洞
- 损失函数不变的话，
```python
def risk_estimation(y_true, y_pred):
    return -100. * K.mean((y_true - 0.0002) * y_pred)
```
- MonteCarlo提出：持股数占比*涨跌幅，这个结果是没有意义的；只有`市值*涨跌幅`才有意义!!!


### 解决方案1
- 要实现预测值为持股数占比，损失函数需要变成以下的样子
```python
def risk_estimation(y_true, y_pred):
    return -100. * K.mean((y_true - 0.0002) * y_pred * open_prices)
```
- 但损失函数无法接受第三个变量，如open_prices；那么能不能改变y_true来适应呢？

方案1: 将 `* open_prices`这个部分直接嵌入到`y_true`当中
- 在设计`y_true`时，将其定义为

```python
open_prices_norm = open_prices / open_prices[0]
y_true = (daily_price_change - 0.0002) * open_prices_norm
# 不再是 `y_true = daily_price_change`
```

- 这样我们就能得到：

```python
def risk_estimation(y_true, y_pred):
	return -100. * K.mean(y_true * y_pred)
        #  = -100. * K.mean(((daily_price_change - 0.0002)* open_prices_norm) * y_pred)
```
这个方案逻辑上有问题吗？可行吗？

### 解决方案2
- MonteCarlo:
	- 应该是openprice
	- day1，有现金（初始市值）A元，预测市值占比为a1，那么股数为A*a1/openprice，付出手续费=股数*openprice*0.001=A*a1*0.001，剩余现金=A*（1-a1)-手续费
- 对应MonteCarlo的建议写成的代码，[在这里](https://github.com/EmbraceLife/LIE/blob/master/my_utils/viz_03_stock_02_ETF_predict_return_plots.py#L320)
- 同样的模型，经过以上的方式进行计算每日总资金和交易成本和降噪处理，好像表现更好了（如果我的代码没有系统错误的话）
- ETF50（全部计算过交易成本），分别是无降噪处理，80%，90%， 95%，97%, 99% 降噪
![](https://lh3.googleusercontent.com/aXapk-htAaTP9uRRJUq9a6pp0hOf_YE6g4s_9SQr2LtAS3hoCUUuj1PT1W1qREIhUOkFUJ_r-bS7V_WUYkjX9IkVprwQE4IAoPX-y-_fvdoi24Cy6O5Db0phZT2MmTYjr7f-ArnUxNIrInOJC-BhPKFMHMrCYoN9zqSf1fs-980KBfd42An_VDuQTmT0PJmPpt1gB-HG9oiIQUTv7A-lQnIXZQHd6pv5R0EkcHW6bZAkvGg5tWMzQYE_owMBdJ5LaL_ZGvd-BPqTIbKgoeXFTn_hsh-llppOMJq2q_vksgX-RzLGaFtFopajxn01JqIch_vbe5EpFxnItD0zJzk1T_rkAHMZzq_hSfLw15r9c26FO1lI1RUrChsk01GoHmAOk3b5TsOQbMpOS9fNtQLF9hp_fkI1rn9I0aHDLdtz_FmKWOQ0GyfFvraXSfwygz3tRwxMS_vo7BMaWl7kYitREOSvdzo6BdAReLGUbee9PHMdffCvVX-CTYG9eiG1K3g80DOdukPnXAQu2h9k5tgtnw71O8KtyrmYNOFpxZmPO2pnW8cYX_ydJmtoNSP_jY5w8NrqeMWjJLR8US6auoZkWXSR2QaEf8WBZGzZlNrfHfBTQFsOuYpsl0YG=w2412-h1224-no)
![](https://lh3.googleusercontent.com/Q7Mltm3sYJj3IoymphTL1CL8YCirnd_zB_v7C0ahnyl1Kzr-4cqUe2Mb_RWREeoglQ0IkTunn-ajJ7-OGY5kK2cj9zPrCMpLDHUfyPUpxx7sZENUUDCe3nhA6js14VE2Ww9tguUs8atyEkn_-_62fVPdFJpM8CeY7gwqan6FFv0dUIb1hQs7g9Gf9zem09AIylZbBjin8ZW06h7Rp2LzCNIAVItg3QKbAWLdshujIe4hnncMQZpJQqE5xf-zs6Yi17rrrVHZDFkpIlxoS-JNTsQAVeZuQsbANf7ex5SFqf2aw8l5170fHuD__S-ESwQ74tE_n6e2uBf2ipEYy275469GvpyKndaecr6Ry0xV9RQ8s8HrZ2ZVIO5DdrLDGfRr2V7-wH4j2me3UCKMXoR59za_rNfMYXLGoeoBcLC9nOW7d08saGPAfDrdQTkbyhgaG3kPgL0RinfDBS9eilL-bdOW1xW5LGGZz91VHqLDNDnz6kpWYubOoyyZe0s8k0k-WaZOznfflwQYJR-vpe8FlQoDgN9n9MJSWbZBMuYNUaxuLgJysJtwqHfnWcbZZECvNguabwUQX4Y3nY3MUCbm26uSO_E40L1U7leoUIJ0KfZuwa3ZA95VsBOh=w2412-h1224-no)
![](https://lh3.googleusercontent.com/eGxEJnkMnIsK1IjeKRJ7oEf63yOscPKDU6yeZ_P1h02F2epidTr6zzA4zr_avIMq0jv0fBD_nWQATi3PFmt7wrewCzLAkYXmGg-cOGnfZPlrjSIGBLzSnhUG0s6TTWKkkVqfuogf5y4GogI-GvoxSiLk2zZvZwMH3zQrnZ83u3pZg2kNEtSWtsUIBtJryeTUfsTtp5YKA3emp9zSM-_RzAeBB9jWpIpbnFcf3ycjDCSHQd2nAvI62X950uOcIos9XUOhHnBiLBCVjZ4TILHkpuZfIBZDpgAm3jSpuxjBxhFZb9sbTGQyUYLD_4dLXS1corTvbOwcbPuye1C1JXldM153kK42vgtiHhNEaOLU5GBTQjXcOr8gsBOU2cLLPg54FcjLrEAKISMolB5FlIPXxlcpoGZclHzcxaz3D0X70xNlpPR-1EG0jE5o2oVczGjRVFgG6Jo8qs5vR54y2GE69GHBTF4Y4EHKGgMfX-O48byHjAb5rIZfRF6-Z7zs7wcBd06yQtxKRYnyq1wITESWF468sE03H6WbjO-MIshQT38FoLxGlmO0Ds6HyLPXBsg_O6FXlm0WujNF9SWXNv8cgcdSSZFNDVd3hdrvXtrcqVNrLpisKjIpgxBi=w2412-h1224-no)
![](https://lh3.googleusercontent.com/ffVy7Vz7sZos82LaGXmv_FSMU2Kbu6KAZJhXFI0VYTYJnCzSX23Kb0PN2CnzwYoBGHk3ny7g1fO_Yu8fU3AMXanEBpYyZiHFg3FRCTQnkH4X99Z8mnF3oeZGpZt0MqniUbikXtCb1JQVYdWAEitz3wt2Ml0qBMCsPoSt69JSsMbQEbs1cvAMTkq8lUrwqfYmjc27kA2jO5pLxhgCeGwIx71STr_Aufwnq2ugKck4jaReXlTadcNIHASCzOYtUCNmI8nbIoVGM-A3v7yk_VZICH8tXcj7IYU3qm46CZQpq9MoByf--VyOvny7ahhwIH1y_fVzjmPk63FrCXzHJbVmyIuAZ-s6zYy06G5RDGjrK0WWhr-VDpF-2c1P4nfyqQsxnqG-mB0_NfFtelMJ6MXUyUzBi5Pv6HHGO2TcaIp0hDBsJwsm2rw_rbS6jvkct10Oae4eYn56Ve4QT8yE-kQQXTNfbLlQJ4axnSkfoT_MmYyy2tH9WJGx8JMRK3mFlyvkQbRtJaXuU29zngwx742nXEbm_6qc3BDodIrJo9AmVO8qGiSazb37ZpahYIKp-U1vHvfsdwdOx5rLa84MXZTJazWiOKnoz3poQKlZSs9FGcqXG1p1Rp2ZYA1b=w2412-h1224-no)
![](https://lh3.googleusercontent.com/BAfu9t60mYGnJFG3SMLFReC-nFwQAxtlfRA4fCWL_aVUFHAwsmPcpX6XcD-nRvBWdUtCmpXrKL0iBgKS1N3EXaWAwcL_vd-4eMq0ozQjfQeAtiBaN-V1QXdgScUbe0N-Prhn3EGSb5pZk213X58M43K_bAyOSZutGYMQ8fZ-1bwiUAB99grvI8GQPlW8zSwSTwMxltCloja_RYIPEcxtdJhxB8WDiUbmKAIhP1bR8p5Y_WrqCyIsdQa7TxygzIS6gIHs3aNhwIM2ipv3yBNbSRWpXN7wVVMSPqCqtq2bTqLv6p8tjBRKSvzfrrlmQxeR9KRuY83oDmYpAj79bI5e5BHSMU7xijCnLKTIOfhVn9ypmAihN83SnzW8FfO8xi1DtrwnFVxLLTlXc97MYIA_M1Xx1PurG4oUheRWVnM4-3LMG1p62rm-UWKiEpswl0YnhPzytjgpUnQLR160Q8T6HjEq-oPVMzMpaO398SyN4CCjmYodeF3O6rPrZKMGl6VcpEzn6ZGJPWsJOvqoxtMscfkYnnDH49NsXP4U4QV46hqzg2tZdniKmOIDi8uL7TgkIa7Ro6dtMu_x5chCoxaB6iPH-CgkEc_6KOs4_6fJi8G1zOU9YezLOnhi=w2412-h1224-no)
![](https://lh3.googleusercontent.com/67JICpQvz1sTSbtPHYLljh1szhZMSns0Zop8-KASWBefgYU_xo-2MeOhCK6JIEs0bqUsAgfH3U6xviJn17u5EnMmda0JScD2cYdeeQYGx4-pDW2tJvNMPNG4tYN5mlYd5He_ijRsJcq6E-9sCPs7MOkKDqdsUTY0_5R5xIxLzOleZovxTPUwbysvqDsRG8Y0s2kqCZvzhZBXa3pJVgSQjAsDdCNKk31vUAEEog2jwH8pmYEOGXL3sY4bXTBeeO053cfxkVFLC-rzmYi8eFdIXOpeJQnGZ4YMMtsLDfzqw29fqNt_dFdQYCUQmqQ7gWVsuwymgDuPiUaI61Ag4JXJ-dG0UURwZqVaDxjWty-IKV-hmA71HvGI51CmySf2Tzf36dqEzbcmw2rS4oKJNeLjTv_9t3lD13JWMCOKyu8yGSNXsffCgTIDCgkEGuylyjzjmBOlYPivcp0H7l1hazLwqWVHfbLX0bnrAe7oy8st1_VnFFVGw8eDesLs-Ye-EZMwhXNsSc9-kITL2SeHRVh-8KEOYur2naVP8DHMUGlkhZU9iAp_CAq1y-9HGNHsK5q01Y6U2obIo2Dwih0GWYqPeKxp979ylTUV3j0sUuuW4KuNm-LN1Pz_dFxW=w2412-h1224-no)
![]()
- ETF300（全部计算过交易成本），分别是无降噪处理，90%， 95%， 99% 降噪
![](https://lh3.googleusercontent.com/uZ91iSMBv-pIOspmE7iUUpBCljAi-W24omCA6Pq5WcrdmRSvNL2FqgIcZefPhht7syrp3h_GrZgYX0UsgpCtNbHekPKOPnm0PYvY4dcLuCHuXerq1HHRZ-n_2u6uuaxlTEawrX5YbnWaw3cVBkhFszXdR30BAK6mS1kMSny_LLOBqOSA47Ugvh-rQf2O0lKeZc2fAKHfp6dLVMynD62ftcghiw5ew1nEqianzzUpgSPIbVturcG1YMPQavGZPSMEeK1b1f4TpK_wyRVn01RMyvfr_BhC1n6Wq6plnLuF_rfhcWBWLWtfIrlGP5c775rgsvhw_mIqSDRRpfZcvzKlkxAKzACcD7gkLSBA-hnbPu1dhvhMgW9A2-qU7b4ViGOVC_E-EkfAgVM-pfPYeIplna1d4OEDTqhTidbLItX86qg8X7zm4Ri67BMJH4sG3WU9RVPuGk0aIroKaYJ5UXuzqxKVddYqx4j7jE3p8-4u68h-a5yKL5ZceBs-nCM_JgwFWgJn73SheoLKSkEwUPBbfju4QldwOFGhqFlFBWsvEAn8q5VXnKYKu2USMag4AhvsP3r-2hdWpYK7Bhzobt268QYeaIIfg_eo51sOo9HaaP0Vic2xvxIwVbYn=w2412-h1224-no)
![](https://lh3.googleusercontent.com/E-6iYmxxW19myTH0I0GzGywdMekru52Ppw51ZnMorFx2IM3Ks1rE0fFKgzZyoPY-dTVOlnloGIxp_AeZG3Y0ZEF0d_hYQJM418LFCEUEU_JtUsRkpmKNpYCRv7de0P_ln-X1N1HaMjkMbiv5HLyVxWXLgcVkVV3G7716b0KG1t1FAaSSyq_kaj5q8kYwzHmf7-SFm6l1o2OkeDN69fH1doH9h7jpopUyl51aOoHqFb6ILij3cacOSjkvPY0Qpd27A52RVfazKPRhjWX2q67MTEcoXyyeU9yB146n7V3xCfbIfUn0GDrn-fpFUgXmylH_rVR5CRfDGMzVku_ML0-xEk6yHDsOlKOAAUA7OK6GPrcGdOJgtGPHkv1VCGOuKUq5tZ-wE6LJ-akJyN0WpLmnqwXi1sb0BDuYnL1MEIuM9PEJLtG9pwKaM6ZmPpFZo-n-FcRaLxavwcOOVYY4AqrBLYMICRuc0es6PRuZ3vfcnzua9pSJYglvWnOiAAg1je6Q2Akufx-j3YLMkdQLrJ2b3_HepWCHUl1AmjhJuQB_fxQ2_T74ChUP8gF0J4tUQpIEFumnacCCka2t08qo51nFItn0RaWkTrSrpBQr1SBLA6zbyhQ2yoJXcKcP=w2412-h1224-no)
![](https://lh3.googleusercontent.com/Ys8KWO1Ct0j13yHUHSICiFuZrBCgHAsWggbF57cYU2PZ7Zf7pZ6wtAYDKZKBy6iNFnoY2gOHm_5qvGJUlDpLbSWpJNEnv6LYEM2-2xSLVJAxeVq63TXsUYmXGPcSl252gzi0tpKftkwtxO-Upr3z7CTR44c7UcEeCGID8l1nxX6OdUacjaYVnB1-CJq1ck2Em2GEY8F_BnA1evjEsyZxUONFuxb7mKm_dhEGW1Ce6LBV-IvbO3BYwwDOkzWAkD6PERYle7Mw2R_QlpWpqnN6jxHpQfaZ4gkSdTIwj-0JItaWkUAwp4BjBucBC4xX0Q1RPODwwyCXxcL2QSVAtsD2saO5YHjDJI6XC3rNP3OAwqirPah4ilemiBk-gdCpBKvLJHx_ypwDnntgIq6eX3T9mxCZJilx7odosREQOvNnpzAEM7fqwHOQ4-SHrDJ-UHjIsMKNCNBtPGbM9HQtfB_TF_DB3FpyBfqsJBuYHMa9sCNR4rP0Q4tbxZR3nFuCglgaPrpK_dXndU-hiwaMOdq7kJacvMHoVb5KBNAesxgqGs6BYDhGDTkzPHRF0pW5TxZIEGRhnYnmfm2zufyiPzTv2PRPpNXXNGa496bUb9IpfP2Z47VnsdEtgBel=w2412-h1224-no)
![](https://lh3.googleusercontent.com/NetcjvCqAHw5m1bLP2NzBdOduiO_ugcfiCEa8hWm0Vr5lgv2rzL2J97jG-3ONpVWdzIt_7RaBDnlwkfPooxTknCHyGeZ0bQe-BXPZb-IQ4It1yA5zAdm-QhJNS7UWsoUNUTQFqw_MvbvhrGE6wKgjqWoZwlfCmhtsiJNbeBhKoio3I1L1XExUTswulQVrz82ibCw6twoCS8mH2MwY8R5vPXCDJ21CU4h3zfve5lU9z5u4vOgCF7yYTwbVTOD-SOc0TicLKtx4gBgdOn4HHtTbOXP4oq30Q5k3LXlILRBvHrBmO7Ew-uWsqzxiTj9dvKa4orkLIM56pQndsk-vYWg-xD9CR06TIZVpROY98XzpTCUCTX02w9vPsgmCNw0M1ARzf1MCwjBj3Wbf_iVbKBwF-6s3nm8ZPUjC_CiHvDjqHSLqrGkh3bJvh1C7IMfekhUnviHHLZPzWM3SHS7F01ngUELNnKkS_jcLvDgJxIrDW8_a7zU3gJwqe0PLxZY-UBbHQtdriw8B2UWO7s-Hcxw3BwuuIkkFEv1R3bzJAiR8eWKbxs_NOOKsfRKSo3vdxz3TGlcgFdNslr2UjhIpzoZqzbWark9HAVNhoHz6_XSMj8RxH8ZFThmP2jt=w2412-h1224-no)
